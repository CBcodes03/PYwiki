{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PYWiki Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { display: flex; flex-direction: column; min-height: 100vh; }
.wrapper { display: flex; flex: 1; }
.sidebar { width: 260px; background-color: #f8f9fa; padding: 1rem; border-right: 1px solid #dee2e6; overflow-y: auto; }
.content { flex: 1; padding: 20px; overflow-y: auto; }
.file-btn:hover { text-decoration: underline; }
ul { list-style: none; padding-left: 0; }
</style>
</head>
<body class="p-4">

<h1 class="mb-4">Admin Panel</h1>

<h2>Create a User</h2>
<form id="create-user-form">
    {% csrf_token %}
    <div class="form-group mb-2">
        <label>Email address</label>
        <input type="email" name="email" class="form-control" placeholder="name@example.com" required>
    </div>
    <div class="form-group mb-2">
        <label>Username</label>
        <input type="text" name="username" class="form-control" placeholder="Username" required>
    </div>
    <div class="form-group mb-2">
        <label>Role</label>
        <select class="form-control" name="role" required>
            <option value="admin">Admin</option>
            <option value="editor">Editor</option>  
            <option value="viewer">Viewer</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary mt-2">Create</button>
</form>

<hr class="my-4">

<h2>Delete a User</h2>
<form id="delete-user-form">
    <h5>Users</h5>
    <div id="user-list" class="form-group mb-3">
        <!-- Users will be inserted dynamically here -->
    </div>
    <button type="submit" class="btn btn-danger">Delete Selected</button>
</form>

<!-- Toast container -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055" id="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Helper: Get CSRF token from cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Function to show toast messages
function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");

    const toast = document.createElement("div");
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");

    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;

    container.appendChild(toast);

    const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
    bsToast.show();

    toast.addEventListener("hidden.bs.toast", () => toast.remove());
}

// Fetch users
async function loadUsers() {
    const userList = document.getElementById('user-list');
    userList.innerHTML = '<p>Loading...</p>';

    try {
        const response = await fetch('/get-user-list/');
        const data = await response.json();
        userList.innerHTML = '';

        data.users.forEach(user => {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = user.id;
            checkbox.id = 'user_' + user.id;
            checkbox.classList.add('form-check-input', 'me-2');

            const label = document.createElement('label');
            label.htmlFor = checkbox.id;
            label.textContent = user.username;
            label.classList.add('form-check-label', 'me-3');

            const div = document.createElement('div');
            div.classList.add('form-check');
            div.appendChild(checkbox);
            div.appendChild(label);
            userList.appendChild(div);
        });
    } catch (error) {
        userList.innerHTML = '<p class="text-danger">Failed to load users.</p>';
        console.error('Error fetching users:', error);
    }
}

// Handle create user
document.getElementById('create-user-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/create-user/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) showToast(result.success, 'success');
        if (result.warning) showToast(result.warning, 'warning');
        if (result.error) showToast(result.error, 'danger');

        e.target.reset();
        loadUsers();
    } catch (err) {
        console.error(err);
        showToast('An unexpected error occurred.', 'danger');
    }
});

// Handle delete user
document.getElementById('delete-user-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const selectedUsers = Array.from(document.querySelectorAll('#user-list input:checked')).map(cb => cb.value);
    if (selectedUsers.length === 0) {
        showToast('Please select at least one user to delete.', 'warning');
        return;
    }

    try {
        const response = await fetch('/delete_users/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ ids: selectedUsers })
        });

        const result = await response.json();

        if (result.success) showToast(result.success, 'success');
        if (result.warning) showToast(result.warning, 'warning');
        if (result.info) showToast(result.info, 'info');
        if (result.error) showToast(result.error, 'danger');

        loadUsers();
    } catch (err) {
        console.error(err);
        showToast('An unexpected error occurred.', 'danger');
    }
});

// Initialize existing toasts (if any rendered by Django messages)
document.addEventListener('DOMContentLoaded', function () {
    var toastElList = [].slice.call(document.querySelectorAll('.toast'))
    var toastList = toastElList.map(function (toastEl) {
        var toast = new bootstrap.Toast(toastEl, { delay: 4000 });
        toast.show();
        return toast;
    });
});

// Initial load
loadUsers();
</script>
</body>
</html>
